{% include "main/base.html" %}
{% include 'main/navbar.html' %}
{% block content %}

<body class="bg-[rgb(18,18,18)] pt-12">
    <div class="max-w-4xl mx-auto mt-8 h-20">
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
      {% for thread in threads %}
        <div class="bg-[rgb(23,23,23)] rounded-lg p-6 shadow-md/40 hover:bg-[rgb(25,25,25)] transition-colors duration-300">
          <h2 class="text-xl font-semibold text-white mb-2 truncate">{{ thread.title }}</h2>
          <p class="text-gray-300 mb-4">
            Тема від {{ thread.author }} &nbsp;•&nbsp; <span class="relative-time">{{ thread.created_at|date:"c" }}</span>
          </p>

          <h4 class="text-white font-semibold mb-2">Коментарі:</h4>
          <div class="space-y-2">
            {% for comment in thread.comments.all %}
              <div class="bg-[rgb(30,30,30)] rounded p-3">
                <b class="text-blue-400">{{ comment.author.username }}</b>
                <p class="text-gray-200">{{ comment.content }}</p>
              </div>
            {% empty %}
              <p class="text-gray-400">Комментаріїв нема</p>
            {% endfor %}
          </div>

          {% if user.is_authenticated %}
            <form method="post" action="{% url 'theme-detail' pk=thread.pk %}" class="mt-3">
              {% csrf_token %}
              <button type="submit"
                      class="mt-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                Додати коментар
              </button>
            </form>
          {% else %}
            <p class="text-gray-400 mt-2">Щоб залишити коментар, <a href="{% url 'login' %}" class="text-blue-400">увійдіть</a>.</p>
          {% endif %}
        </div>
      {% empty %}
        <div class="text-center text-gray-400">Поки що тем нема</div>
      {% endfor %}
      </div>
    </div>
</body>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function getUkrainianPlural(number, one, few, many) {
    number = Math.abs(number);
    if (number % 10 === 1 && number % 100 !== 11) { return one; }
    if ([2, 3, 4].includes(number % 10) && ![12, 13, 14].includes(number % 100)) { return few; }
    return many;
  }

  // Функція тепер приймає ОБ'ЄКТ дати, а не рядок
  function toRelativeTime(date) {
    const now = new Date();
    const seconds = Math.round((now - date) / 1000);
    const minutes = Math.round(seconds / 60);
    const hours = Math.round(minutes / 60);
    const days = Math.round(hours / 24);
    const months = Math.round(days / 30.44);
    const years = Math.round(days / 365.25);

    if (seconds < 60) {
      return 'щойно';
    } else if (minutes < 60) {
      return `${minutes} ${getUkrainianPlural(minutes, 'хвилину', 'хвилини', 'хвилин')} тому`;
    } else if (hours < 24) {
      return `${hours} ${getUkrainianPlural(hours, 'годину', 'години', 'годин')} тому`;
    } else if (days < 30) {
      return `${days} ${getUkrainianPlural(days, 'день', 'дні', 'днів')} тому`;
    } else if (months < 12) {
      return `${months} ${getUkrainianPlural(months, 'місяць', 'місяці', 'місяців')} тому`;
    } else {
      return `${years} ${getUkrainianPlural(years, 'рік', 'роки', 'років')} тому`;
    }
  }

  const timeElements = document.querySelectorAll('.relative-time');
  timeElements.forEach(element => {
    const dateString = (element.textContent || element.innerText).trim();
    if (dateString) {
      const date = new Date(dateString);

      // ПЕРЕВІРКА: чи є дата валідною
      if (isNaN(date.getTime())) {
        // Якщо дата не розпізнана, виводимо помилку
        console.error("Не вдалося розпізнати формат дати:", dateString);
        // Можна також показати помилку користувачу
        element.textContent = `[Невірний формат: ${dateString}]`;
      } else {
        // Якщо все добре, конвертуємо час
        element.textContent = toRelativeTime(date);
      }
    }
  });
});
</script>
</html>

{% endblock %}
